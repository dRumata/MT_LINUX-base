## LAB15-1. Управление програмным обеспечением

#### 1. Использование dnf для управления пакетами 


1. Чтобы отобразить список текущих репозиториев, которые использует ваша система, введите
```bash
dnf repolist
```


2. Введите `dnf search seinfo`. Это не даст результата. 

3. Введите `dnf provides */seinfo`. Команда показывает, что пакет setools-console-<version> содержит этот файл. 

4. Установите этот пакет с помощью dnf install -y setools-console. В зависимости от вашей текущей конфигурации вы можете заметить, что также необходимо установить зависимости
```console
Зависимости разрешены.
===================================================================================================
 Пакет                       Архитектура        Версия                    Репозиторий        Размер
===================================================================================================
Установка:
 setools-console             x86_64             4.4.0-9.fc37              fedora              39 k

Результат транзакции
===================================================================================================
Установка  1 Пакет

Объем загрузки: 39 k
Объем изменений: 127 k
Загрузка пакетов:
setools-console-4.4.0-9.fc37.x86_64.rpm                             67 kB/s |  39 kB     00:00
---------------------------------------------------------------------------------------------------
Общий размер                                                        25 kB/s |  39 kB     00:01
Проверка транзакции
Проверка транзакции успешно завершена.
Идет проверка транзакции
Тест транзакции проведен успешно.
Выполнение транзакции
  Подготовка       :                                                                           1/1
  Установка        : setools-console-4.4.0-9.fc37.x86_64                                       1/1
  Запуск скриптлета: setools-console-4.4.0-9.fc37.x86_64                                       1/1
  Проверка         : setools-console-4.4.0-9.fc37.x86_64                                       1/1

Установлен:
  setools-console-4.4.0-9.fc37.x86_64

Выполнено!
```

5. Введите `dnf list setools-console`. Вы видите, что пакет указан как установленный. 

6. Введите `dnf history` и запишите номер последней использованной вами команды dnf. 

7. Введите `dnf history undo <nn>` (где `<nn>` заменяется числом, которое вы нашли на шаге 6). Данная команда отменяет последнее действие и удаляет только что установленный пакет. 
>![Screenshot](../img/scr.png) ***Cделайте скриншот экрана c результатом выполнения задания для отправки отчета.***
8. Повторите команду `dnf list setools-console`. Теперь пакет отображается как доступный, но не установленный.

#### 2. Использование запросов RPM
9. Введите which dnsmasq. Эта команда дает полный путь к команде dnsmasq. 

10. Введите `rpm -qf $(which dnsmasq)`. Это сделает запрос файла RPM по результату команды `which dnsmasq`

11. Теперь, когда вы знаете, что двоичный файл dnsmasq поступает из пакета dnsmasq, используйте команду `rpm -qi dnsmasq`, чтобы отобразить дополнительную информацию о пакете. 

12. Информация, отображаемая с помощью `rpm -qi`, полезна, но не дает подробностей, необходимых для начала работы с программным обеспечением в пакете. Используйте команду `rpm -ql dnsmasq`, чтобы отобразить список всех файлов в пакете. 

13. Используйте команду `rpm -qd dnsmasq`, чтобы просмотреть доступную документацию. Обратите внимание, что эта команда показывает, что существует страница руководства, но есть также файл **doc.html** и файл **setup.html** в каталоге **/usr/share/doc/dnsmasq-version**. Откройте эти файлы в своем браузере, чтобы получить дополнительную информацию об использовании **dnsmasq**. 

14. Введите `rpm -qc dnsmasq`, чтобы увидеть, какие файлы конфигурации используются dnsmasq. 

15. После установки это не имеет особого смысла, но всегда полезно знать, какие сценарии выполняются при установке пакета. Используйте `rpm -q --scripts dnsmasq`, чтобы показать код сценария, который может быть выполнен из этого **RPM**.

#### 3. Создаём собственный репозиторий для Fedora

16. Установим стандартный набор для сборки и подписи пакетов:
```bash    
sudo dnf install rpm-sign createrepo
```

17. Сгенерируем **GPG**-ключи, которыми будут подписаны пакеты
```bash	
sudo gpg2 --gen-key
```
При запросе `Ваше полное имя:` создайте удобное для запоминание имя ключа:
```console
gpg (GnuPG) 2.3.8; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Замечание: "gpg --full-generate-key" вызывает полнофункциональный диалог создания ключа.

GnuPG должен составить идентификатор пользователя для идентификации ключа.

Ваше полное имя: voit
Адрес электронной почты:
Вы выбрали следующий идентификатор пользователя:
    "voit"

Сменить (N)Имя, (E)Адрес; (O)Принять/(Q)Выход? O
```
При вводе пароля используйте `Pa$$w0rd`
```console
      ┌────────────────────────────────────────────────────────┐
      │ Введите фразу-пароль                                   │
      │ для защиты нового ключа                                │
      │                                                        │
      │ Фраза-пароль: ********________________________________ │
      │                                                        │
      │        <OK>                         <Отмена (C)>       │
      └────────────────────────────────────────────────────────┘
```
18. Экспортируйте ключ в файл:
```bash	
sudo gpg2 --export --armor 21AF18C6 > RPM-GPG-KEY-foobar-37
```
Здесь 21AF18C6 — ID ключа, foobar — название нашего репозитория, а 37 — релиз Fedora, для которого он предназначен.

19.  Просмотрите содержимое ключа:
```bash
cat RPM-GPG-KEY-test-37
```

20.  Создадим базовую иерархию каталогов, в которых будут расположены собранные RPM пакеты и **SRPM** файлы для целевого дистрибутива.

Если публикация архивов с исходниками не требуется, то каталог для **SRPM** можно не создавать и, соответственно, удалить всю секцию **foobar-source** из ***.repo** файла.

Создадим каталоги для **Fedora 37**:
```bash
mkdir -p ~/fedora/37/{$(uname -m),SRPM}
```
Внутри архитектурно-зависимого каталога будем размещать RPM-пакеты, включая noarch и, при необходимости поддержки multilib в 64-битной версии Fedora, также 32-битные версии для архитектуры i686.

В SRPM скопируем *.src.rpm файлы с исходниками.


21. Скачайте последнюю версию **vscodium** (https://github.com/VSCodium/vscodium/releases/) и добавьте в свой репозиторий:
```bash
wget https://github.com/VSCodium/vscodium/releases/download/1.78.2.23132/codium-1.78.2.23132-el7.x86_64.rpm
mv ~/*.rpm ~/fedora/37/$(uname -m)/
mv /tmp/repo/*.src.rpm ~/fedora/37/SRPM/
```
> рекомендуется проверить контрольную сумму скачаного **rpm**

22. Подпись RPM пакетов. Создайте файл /root/.rpmmacros следующего содержания:
```ini
%_signature gpg2
%_gpg_name 21AF18C6
```
Здесь 21AF18C6 — ID ключа для подписи репозитория.

К сожалению, **rpm-sign** не поддерживает указание ID ключа индивидуально, поэтому перед подписью каждого репозитория его придётся менять внутри данного файла.

23. Подпишем все RPM-пакеты в репозитории для Fedora 37:
```bash
sudo rpm --addsign ~/fedora/37/*/*.rpm
```
При необходимости заменим ключ в **/root/.rpmmacros** и повторим действие для всех оставшихся репозиториев.

24. Создание репозитория
С помощью утилиты createrepo сгенерируем метаданные, после чего наш набор файлов станет полноценным репозиторием и сможет использоваться на машинах конечных пользователей:
```bash
createrepo --database ~/fedora/*/
```
Пример результата:
```console
Directory walk started
Directory walk done - 1 packages
Temporary output repo path: fedora/37/.repodata/
Preparing sqlite DBs
Pool started (with 5 workers)
Pool finished
```

25. Проверьте содержимое созданного репозитория
```bash
tree fedora/
```
Пример результата:
```console
fedora/
└── 37
    ├── repodata
    │   ├── 1e12152824dde2ffa5428eb656ee106fa347749c800201e4bcc50dcf9af02c00-other.xml.gz
    │   ├── 7d86e71c379ebb8c824a3249c93d7f2e7caac6befd44ac614a8400dc04d93600-other.sqlite.bz2
    │   ├── a43a538be446cb7e79f76aebd7abcd4aea790a59121f43ac135da81d160cc7a4-primary.xml.gz
    │   ├── aae0815cca9110b6eaf4e1953399609f068011842e1b5a63c3c7c25e076e3ab0-filelists.xml.gz
    │   ├── cfdb414b920dbc94b3e37750c938e1e2f50f6ed2a41bda1a0444e0a7f892781d-primary.sqlite.bz2
    │   ├── fb8b2299e1c18d38d3796c0220a846be865aed9392f66e6de228d2be0ca1030b-filelists.sqlite.bz2
    │   └── repomd.xml
    ├── SRPM
    └── x86_64
        └── codium-1.78.2.23132-el7.x86_64.rpm
```
26. Проверьте доступность сервиса **Apache**, если его нет установите и добавьте правило фаервола.
```bash
systemctl status httpd
sudo dnf install httpd
sudo systemctl enable httpd
sudo systemctl start httpd
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --add-service=http
```

27. Скопируйте каталог **fedora** в **/var/www/html/**

28. Подключение репозитория. Для подключения репозитория создадим файл репозитория на машинах пользователей `vim myrepo.repo` и скопируем его в каталог **/etc/yum.repos.d/**:
```repo
[myrepo]
name=MyRepo $releasever - $basearch
baseurl=http://[YOUR_IP]/fedora/$releasever/
enabled=1
metadata_expire=12h
repo_gpgcheck=0
type=rpm
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-foobar-$releasever
skip_if_unavailable=True

[myrepo-source]
name=MyRepo $releasever - Source
baseurl=http://[YOUR_IP]/fedora/$releasever/SRPMS/
enabled=0
metadata_expire=12h
repo_gpgcheck=0
type=rpm
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-foobar-$releasever
skip_if_unavailable=True
```
> не забудьте указать правильный ip сервера и путь к файлу ключа

29. Разместите любым известным вам способом на пользовательской машине в директорию **/etc/pki/rpm-gpg/** ключ репозитория ранее созданный на сервере (шаг 17)

30. Просмотрите информацию о наличии пакета **codium** в репозиториях и найдите свой репозиторий в списке.

31. Установите или обновите пакет **codium**. При запросе отпечатка ключа, подтвердите добавление.
```console
...
Импорт GPG-ключа 0x876398A7:
Идентификатор пользователя:  "voit"
Отпечаток: F567 F0BA 2F1E 6773 0019 32B3 8930 1ACC 8763 98A7
Источник:  /etc/pki/rpm-gpg/RPM-GPG-KEY-test-37
Продолжить? [д/Н]: y
Импорт ключа успешно завершен
Проверка транзакции
Проверка транзакции успешно завершена.
Идет проверка транзакции
Тест транзакции проведен успешно.
...
```
>![Screenshot](../img/scr.png) ***Cделайте скриншот экрана c результатом выполнения задания для отправки отчета.***